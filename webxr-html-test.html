<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebXR Html å¯è§æ€§æµ‹è¯•</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            position: relative;
            overflow: hidden;
        }

        /* æµ‹è¯•è¯´æ˜é¢æ¿ */
        .info-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 1000;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 20px;
            border-radius: 8px;
            max-width: 400px;
            backdrop-filter: blur(10px);
        }

        .info-panel h3 {
            margin-bottom: 15px;
            color: #ff6b35;
        }

        .info-panel p {
            margin-bottom: 10px;
            line-height: 1.5;
        }

        .info-panel ul {
            margin-left: 20px;
            margin-bottom: 15px;
        }

        .info-panel button {
            padding: 10px 20px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            margin-top: 10px;
        }

        .info-panel button:disabled {
            background: #666;
            cursor: not-allowed;
        }

        .info-panel button.danger {
            background: #f44336;
        }

        /* Html æµ‹è¯•é¢æ¿ */
        .html-test-panel {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.95);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            text-align: center;
            min-width: 400px;
            border: 3px solid #ff6b35;
            transition: all 0.3s ease;
        }

        .html-test-panel h2 {
            color: #ff6b35;
            margin-bottom: 20px;
            font-size: 28px;
        }

        .status-indicator {
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-weight: bold;
        }

        .status-indicator.vr-mode {
            background: #ffebee;
            color: #d32f2f;
        }

        .status-indicator.normal-mode {
            background: #e8f5e8;
            color: #388e3c;
        }

        .test-controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: center;
            margin-bottom: 20px;
        }

        .test-button {
            padding: 12px 24px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            min-width: 200px;
        }

        .test-button:hover {
            background: #45a049;
        }

        .info-box {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .info-box p {
            margin: 0;
            color: #666;
            line-height: 1.5;
        }

        .color-circles {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 20px;
        }

        .color-circle {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 20px;
        }

        .color-circle.orange {
            background: #ff6b35;
        }

        .color-circle.blue {
            background: #2196F3;
        }

        .tips {
            font-size: 14px;
            color: #999;
            margin-top: 20px;
            font-style: italic;
        }

        /* 3D åœºæ™¯å®¹å™¨ */
        .scene-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        /* è®¾å¤‡ä¿¡æ¯ */
        .device-info {
            background: rgba(255, 107, 53, 0.1);
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 15px;
            border-left: 4px solid #ff6b35;
        }

        .device-info strong {
            color: #ff6b35;
        }

        /* æ—¥å¿—è¾“å‡º */
        .log-output {
            background: rgba(0, 0, 0, 0.9);
            color: #00ff00;
            padding: 15px;
            border-radius: 6px;
            margin-top: 15px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 150px;
            overflow-y: auto;
        }

        .log-entry {
            margin-bottom: 5px;
        }

        .log-entry.error {
            color: #ff4444;
        }

        .log-entry.warning {
            color: #ffaa00;
        }

        .log-entry.info {
            color: #00aaff;
        }
    </style>
</head>
<body>
    <!-- æµ‹è¯•è¯´æ˜é¢æ¿ -->
    <div class="info-panel">
        <h3>ğŸ§ª WebXR Html å¯è§æ€§æµ‹è¯•</h3>

        <div class="device-info">
            <strong>è®¾å¤‡ä¿¡æ¯:</strong> <span id="deviceInfo">æ£€æµ‹ä¸­...</span>
        </div>

        <div>
            <strong>WebXR æ”¯æŒ:</strong> <span id="webxrSupport">æ£€æµ‹ä¸­...</span>
        </div>

        <div>
            <strong>ä¼šè¯çŠ¶æ€:</strong> <span id="sessionStatus">æœªå¯åŠ¨</span>
        </div>

        <p><strong>æµ‹è¯•è¯´æ˜:</strong></p>
        <ul>
            <li>PC æµè§ˆå™¨: Html å…ƒç´ åº”è¯¥å§‹ç»ˆå¯è§</li>
            <li>VR è®¾å¤‡: è¿›å…¥ WebXR æ¨¡å¼å Html å…ƒç´ åº”è¯¥æ¶ˆå¤±</li>
        </ul>

        <button id="startVRBtn" onclick="startVRSession()">
            ğŸ¥½ è¿›å…¥ VR æ¨¡å¼
        </button>

        <button id="toggleHtmlBtn" onclick="toggleHtmlVisibility()">
            åˆ‡æ¢ Html å¯è§æ€§
        </button>

        <button id="testWebXRBtn" onclick="testWebXRSupport()" class="danger">
            é‡æ–°æ£€æµ‹ WebXR
        </button>

        <!-- æ—¥å¿—è¾“å‡º -->
        <div class="log-output" id="logOutput">
            <div class="log-entry info">ğŸš€ WebXR Html æµ‹è¯•å·²å¯åŠ¨</div>
        </div>
    </div>

    <!-- 3D åœºæ™¯å®¹å™¨ -->
    <div class="scene-container">
        <canvas id="webglCanvas"></canvas>
    </div>

    <!-- Html æµ‹è¯•é¢æ¿ -->
    <div id="htmlTestPanel" class="html-test-panel">
        <h2>ğŸ¯ Html æµ‹è¯•é¢æ¿</h2>

        <div id="statusIndicator" class="status-indicator normal-mode">
            <p>ğŸ–¥ï¸ æ™®é€šæ¨¡å¼ - Html å…ƒç´ åº”è¯¥å¯è§</p>
        </div>

        <div class="test-controls">
            <div class="info-box">
                <p>è¿™æ˜¯ä¸€ä¸ªçº¯ Html å…ƒç´ ï¼Œç”¨äºéªŒè¯ WebXR æ¨¡å¼ä¸‹çš„å¯è§æ€§</p>
            </div>

            <button class="test-button" onclick="showAlert()">
                ğŸ”” ç‚¹å‡»æµ‹è¯•æŒ‰é’®
            </button>

            <button class="test-button" onclick="changeColor()">
                ğŸ¨ æ”¹å˜èƒŒæ™¯è‰²
            </button>
        </div>

        <div class="color-circles">
            <div class="color-circle orange">A</div>
            <div class="color-circle blue">B</div>
        </div>

        <div class="info-box">
            <p><strong>é¢„æœŸè¡Œä¸º:</strong></p>
            <p>â€¢ PC æµè§ˆå™¨: æ­¤é¢æ¿å§‹ç»ˆå¯è§</p>
            <p>â€¢ VR è®¾å¤‡: è¿›å…¥ WebXR æ¨¡å¼åæ¶ˆå¤±</p>
        </div>

        <p class="tips">
            ğŸ’¡ æç¤º: å¦‚æœè¿›å…¥ VR æ¨¡å¼åä»ç„¶çœ‹åˆ°è¿™ä¸ªé¢æ¿ï¼Œè¯´æ˜è®¾å¤‡æ”¯æŒ DOM å åŠ 
        </p>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let xrSession = null;
        let xrRefSpace = null;
        let animationFrameId = null;
        let scene3D = null;

        // æ—¥å¿—å‡½æ•°
        function log(message, type = 'info') {
            const logOutput = document.getElementById('logOutput');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logOutput.appendChild(entry);
            logOutput.scrollTop = logOutput.scrollHeight;
            console.log(`[${type}] ${message}`);
        }

        // åˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', () => {
            log('ğŸš€ é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–...');
            detectDevice();
            checkWebXRSupport();
            init3DScene();
        });

        // æ£€æµ‹è®¾å¤‡ä¿¡æ¯
        function detectDevice() {
            const ua = navigator.userAgent;
            let deviceInfo = 'æœªçŸ¥è®¾å¤‡';

            if (ua.includes('Pico')) {
                deviceInfo = 'Pico VR è®¾å¤‡';
            } else if (ua.includes('Oculus') || ua.includes('Meta')) {
                deviceInfo = 'Meta Quest è®¾å¤‡';
            } else if (ua.includes('Windows')) {
                deviceInfo = 'PC æµè§ˆå™¨';
            } else if (ua.includes('Android')) {
                deviceInfo = 'Android è®¾å¤‡';
            } else if (ua.includes('Mac')) {
                deviceInfo = 'Mac æµè§ˆå™¨';
            }

            document.getElementById('deviceInfo').textContent = deviceInfo;
            log(`ğŸ“± æ£€æµ‹åˆ°è®¾å¤‡: ${deviceInfo}`);

            return deviceInfo;
        }

        // æ£€æŸ¥ WebXR æ”¯æŒ
        function checkWebXRSupport() {
            if (!navigator.xr) {
                document.getElementById('webxrSupport').textContent = 'ä¸æ”¯æŒ';
                document.getElementById('webxrSupport').style.color = '#f44336';
                log('âŒ æµè§ˆå™¨ä¸æ”¯æŒ WebXR', 'error');
                document.getElementById('startVRBtn').disabled = true;
                return false;
            }

            navigator.xr.isSessionSupported('immersive-vr').then(supported => {
                const supportText = supported ? 'æ”¯æŒæ²‰æµ¸å¼ VR' : 'ä¸æ”¯æŒæ²‰æµ¸å¼ VR';
                document.getElementById('webxrSupport').textContent = supportText;
                document.getElementById('webxrSupport').style.color = supported ? '#4CAF50' : '#f44336';

                if (supported) {
                    log('âœ… WebXR æ²‰æµ¸å¼ VR æ”¯æŒå·²ç¡®è®¤');
                } else {
                    log('âš ï¸ è®¾å¤‡ä¸æ”¯æŒæ²‰æµ¸å¼ VR', 'warning');
                    document.getElementById('startVRBtn').disabled = true;
                }
            }).catch(error => {
                log(`âŒ WebXR æ£€æµ‹å¤±è´¥: ${error.message}`, 'error');
                document.getElementById('webxrSupport').textContent = 'æ£€æµ‹å¤±è´¥';
                document.getElementById('webxrSupport').style.color = '#f44336';
            });

            return true;
        }

        // å¼€å§‹ VR ä¼šè¯
        async function startVRSession() {
            if (!navigator.xr) {
                alert('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒ WebXR');
                return;
            }

            try {
                log('ğŸš€ æ­£åœ¨å¯åŠ¨ WebXR VR ä¼šè¯...');

                // æ£€æŸ¥æ”¯æŒ
                const isSupported = await navigator.xr.isSessionSupported('immersive-vr');
                if (!isSupported) {
                    alert('æ‚¨çš„è®¾å¤‡ä¸æ”¯æŒæ²‰æµ¸å¼ VR');
                    log('âŒ è®¾å¤‡ä¸æ”¯æŒæ²‰æµ¸å¼ VR', 'error');
                    return;
                }

                // è¯·æ±‚ä¼šè¯
                xrSession = await navigator.xr.requestSession('immersive-vr', {
                    requiredFeatures: ['local-floor']
                });

                log('âœ… WebXR VR ä¼šè¯å¯åŠ¨æˆåŠŸï¼');

                // æ›´æ–° UI çŠ¶æ€
                document.getElementById('sessionStatus').textContent = 'VR æ¨¡å¼å·²æ¿€æ´»';
                document.getElementById('sessionStatus').style.color = '#4CAF50';
                document.getElementById('startVRBtn').disabled = true;
                document.getElementById('startVRBtn').textContent = 'VR æ¨¡å¼å·²æ¿€æ´»';

                // æ›´æ–°çŠ¶æ€æŒ‡ç¤ºå™¨
                const statusIndicator = document.getElementById('statusIndicator');
                statusIndicator.className = 'status-indicator vr-mode';
                statusIndicator.innerHTML = '<p>ğŸ¥½ VR æ¨¡å¼ - æ£€æŸ¥æ­¤é¢æ¿æ˜¯å¦å¯è§</p>';

                // è®¾ç½®ä¼šè¯ç»“æŸç›‘å¬
                xrSession.addEventListener('end', () => {
                    log('ğŸ‘‹ WebXR ä¼šè¯å·²ç»“æŸ');
                    document.getElementById('sessionStatus').textContent = 'å·²ç»“æŸ';
                    document.getElementById('sessionStatus').style.color = '#f44336';
                    document.getElementById('startVRBtn').disabled = false;
                    document.getElementById('startVRBtn').textContent = 'ğŸ¥½ è¿›å…¥ VR æ¨¡å¼';

                    // æ¢å¤çŠ¶æ€æŒ‡ç¤ºå™¨
                    const statusIndicator = document.getElementById('statusIndicator');
                    statusIndicator.className = 'status-indicator normal-mode';
                    statusIndicator.innerHTML = '<p>ğŸ–¥ï¸ æ™®é€šæ¨¡å¼ - Html å…ƒç´ åº”è¯¥å¯è§</p>';

                    xrSession = null;

                    // åœæ­¢ VR æ¸²æŸ“å¾ªç¯
                    if (animationFrameId) {
                        cancelAnimationFrame(animationFrameId);
                        animationFrameId = null;
                    }
                });

                // è®¾ç½®å‚è€ƒç©ºé—´
                xrRefSpace = await xrSession.requestReferenceSpace('local-floor');

                // å¼€å§‹æ¸²æŸ“å¾ªç¯
                startVRRenderLoop();

                // é‡è¦ï¼šè§‚å¯Ÿ Html å…ƒç´ è¡Œä¸º
                log('ğŸ” ç°åœ¨è§‚å¯Ÿ Html é¢æ¿æ˜¯å¦æ¶ˆå¤±...');
                log('ğŸ’¡ åœ¨ PC æµè§ˆå™¨ä¸­ï¼šHtml åº”è¯¥ä»ç„¶å¯è§');
                log('ğŸ’¡ åœ¨ VR è®¾å¤‡ä¸­ï¼šHtml åº”è¯¥æ¶ˆå¤±');

            } catch (error) {
                log(`âŒ WebXR å¯åŠ¨å¤±è´¥: ${error.message}`, 'error');
                alert(`WebXR å¯åŠ¨å¤±è´¥: ${error.message}`);
            }
        }

        // å¼€å§‹ VR æ¸²æŸ“å¾ªç¯
        function startVRRenderLoop() {
            if (!xrSession) return;

            function onXRFrame(time, frame) {
                if (!xrSession) return;

                animationFrameId = xrSession.requestAnimationFrame(onXRFrame);

                // è·å–å§¿æ€ä¿¡æ¯
                const pose = frame.getViewerPose(xrRefSpace);
                if (pose) {
                    // è¿™é‡Œå¯ä»¥æ·»åŠ  3D æ¸²æŸ“é€»è¾‘
                    // ç°åœ¨é‡ç‚¹è§‚å¯Ÿ Html å…ƒç´ çš„è¡Œä¸º
                }
            }

            animationFrameId = xrSession.requestAnimationFrame(onXRFrame);
            log('ğŸ”„ VR æ¸²æŸ“å¾ªç¯å·²å¯åŠ¨');
        }

        // åˆ‡æ¢ Html å¯è§æ€§
        function toggleHtmlVisibility() {
            const panel = document.getElementById('htmlTestPanel');
            const isVisible = panel.style.display !== 'none';

            panel.style.display = isVisible ? 'none' : 'block';
            log(`${isVisible ? 'éšè—' : 'æ˜¾ç¤º'} Html æµ‹è¯•é¢æ¿`);
        }

        // æµ‹è¯• WebXR æ”¯æŒ
        function testWebXRSupport() {
            log('ğŸ” é‡æ–°æ£€æµ‹ WebXR æ”¯æŒ...');
            checkWebXRSupport();
        }

        // æ˜¾ç¤ºè­¦å‘Šï¼ˆæµ‹è¯•äº¤äº’ï¼‰
        function showAlert() {
            const deviceInfo = document.getElementById('deviceInfo').textContent;
            const sessionStatus = document.getElementById('sessionStatus').textContent;

            alert(`è®¾å¤‡: ${deviceInfo}\nWebXR çŠ¶æ€: ${sessionStatus}\n\nè¿™ä¸ªè­¦å‘Šæ¡†ä¹Ÿæ˜¯ Html å…ƒç´ ï¼`);
            log('ğŸ”” æ˜¾ç¤ºäº† Html è­¦å‘Šæ¡†');
        }

        // æ”¹å˜èƒŒæ™¯è‰²ï¼ˆæµ‹è¯•äº¤äº’ï¼‰
        function changeColor() {
            const panel = document.getElementById('htmlTestPanel');
            const colors = [
                'linear-gradient(135deg, #ff6b35, #f7941d)',
                'linear-gradient(135deg, #2196F3, #21CBF3)',
                'linear-gradient(135deg, #9C27B0, #E91E63)',
                'linear-gradient(135deg, #4CAF50, #8BC34A)'
            ];

            const currentColor = panel.style.background;
            let newColor = colors[Math.floor(Math.random() * colors.length)];

            // ç¡®ä¿æ–°é¢œè‰²ä¸å½“å‰é¢œè‰²ä¸åŒ
            while (newColor === currentColor) {
                newColor = colors[Math.floor(Math.random() * colors.length)];
            }

            panel.style.background = newColor;
            log('ğŸ¨ æ”¹å˜äº† Html é¢æ¿èƒŒæ™¯è‰²');
        }

        // åˆå§‹åŒ– 3D åœºæ™¯
        function init3DScene() {
            const canvas = document.getElementById('webglCanvas');
            if (!canvas) return;

            try {
                // è·å– WebGL ä¸Šä¸‹æ–‡
                const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
                if (!gl) {
                    log('âŒ æ— æ³•è·å– WebGL ä¸Šä¸‹æ–‡', 'error');
                    return;
                }

                // è®¾ç½®ç”»å¸ƒå¤§å°
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;

                // è®¾ç½®è§†å£
                gl.viewport(0, 0, canvas.width, canvas.height);

                // è®¾ç½®æ¸…é™¤é¢œè‰²ï¼ˆé€æ˜ï¼‰
                gl.clearColor(0.0, 0.0, 0.0, 0.0);
                gl.clear(gl.COLOR_BUFFER_BIT);

                // ç®€å•çš„é¡¶ç‚¹ç€è‰²å™¨
                const vertexShaderSource = `
                    attribute vec2 a_position;
                    void main() {
                        gl_Position = vec4(a_position, 0.0, 1.0);
                    }
                `;

                // ç®€å•çš„ç‰‡æ®µç€è‰²å™¨
                const fragmentShaderSource = `
                    precision mediump float;
                    uniform float u_time;
                    void main() {
                        vec2 uv = gl_FragCoord.xy / vec2(${canvas.width.toFixed(1)}, ${canvas.height.toFixed(1)});
                        float color = sin(u_time + uv.x * 10.0) * 0.5 + 0.5;
                        gl_FragColor = vec4(color * 0.2, color * 0.8, color, 0.8);
                    }
                `;

                // åˆ›å»ºç€è‰²å™¨
                function createShader(gl, type, source) {
                    const shader = gl.createShader(type);
                    gl.shaderSource(shader, source);
                    gl.compileShader(shader);

                    if (!gl.getShaderParameter(shader, gl.COMPILE_STATUS)) {
                        log(`âŒ ç€è‰²å™¨ç¼–è¯‘å¤±è´¥: ${gl.getShaderInfoLog(shader)}`, 'error');
                        gl.deleteShader(shader);
                        return null;
                    }

                    return shader;
                }

                const vertexShader = createShader(gl, gl.VERTEX_SHADER, vertexShaderSource);
                const fragmentShader = createShader(gl, gl.FRAGMENT_SHADER, fragmentShaderSource);

                if (!vertexShader || !fragmentShader) return;

                // åˆ›å»ºç¨‹åº
                const program = gl.createProgram();
                gl.attachShader(program, vertexShader);
                gl.attachShader(program, fragmentShader);
                gl.linkProgram(program);

                if (!gl.getProgramParameter(program, gl.LINK_STATUS)) {
                    log(`âŒ ç¨‹åºé“¾æ¥å¤±è´¥: ${gl.getProgramInfoLog(program)}`, 'error');
                    return;
                }

                // åˆ›å»ºç¼“å†²åŒº
                const positionBuffer = gl.createBuffer();
                gl.bindBuffer(gl.ARRAY_BUFFER, positionBuffer);

                // å®šä¹‰ä¸‰è§’å½¢é¡¶ç‚¹
                const positions = [
                    -0.5, -0.5,
                     0.5, -0.5,
                     0.0,  0.5
                ];
                gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(positions), gl.STATIC_DRAW);

                // è·å–å±æ€§å’Œç»Ÿä¸€å˜é‡ä½ç½®
                const positionLocation = gl.getAttribLocation(program, 'a_position');
                const timeLocation = gl.getUniformLocation(program, 'u_time');

                // æ¸²æŸ“å¾ªç¯
                function render(time) {
                    gl.clear(gl.COLOR_BUFFER_BIT);

                    gl.useProgram(program);

                    gl.bindBuffer(gl.ARRAY_BUFFER, positionBuffer);
                    gl.enableVertexAttribArray(positionLocation);
                    gl.vertexAttribPointer(positionLocation, 2, gl.FLOAT, false, 0, 0);

                    gl.uniform1f(timeLocation, time * 0.001);

                    gl.drawArrays(gl.TRIANGLES, 0, 3);

                    requestAnimationFrame(render);
                }

                requestAnimationFrame(render);
                log('ğŸ® 3D åœºæ™¯åˆå§‹åŒ–å®Œæˆ');

                // çª—å£å¤§å°è°ƒæ•´
                window.addEventListener('resize', () => {
                    canvas.width = window.innerWidth;
                    canvas.height = window.innerHeight;
                    gl.viewport(0, 0, canvas.width, canvas.height);
                });

            } catch (error) {
                log(`âŒ 3D åœºæ™¯åˆå§‹åŒ–å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æ¸…ç†å‡½æ•°
        window.addEventListener('beforeunload', () => {
            if (xrSession) {
                xrSession.end().catch(() => {});
            }
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
            }
        });
    </script>
</body>
</html>
